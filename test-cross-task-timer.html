<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Task Timer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #007cba;
        }
        .nav-buttons {
            margin: 10px 0;
        }
        .nav-buttons button {
            margin: 5px;
            padding: 10px 15px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .nav-buttons button:hover {
            background: #005a87;
        }
        .status {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Cross-Task Timer Test</h1>
    
    <div class="test-section">
        <h3>üéØ Test Objective</h3>
        <p>Verify that the countdown timer continues across all task pages (/task/1, /task/2, /task/3, etc.) and tracks the total time spent across all tasks.</p>
    </div>

    <div class="test-section">
        <h3>üìç Current URL Simulation</h3>
        <div class="status" id="current-url">
            <strong>Current Path:</strong> <span id="url-display">/task/1</span>
        </div>
        
        <div class="nav-buttons">
            <button onclick="navigateTo('/task/1')">Go to Task 1</button>
            <button onclick="navigateTo('/task/2')">Go to Task 2</button>
            <button onclick="navigateTo('/task/3')">Go to Task 3</button>
            <button onclick="navigateTo('/home')">Go to Home</button>
        </div>
    </div>

    <div class="test-section">
        <h3>‚è±Ô∏è Timer Status</h3>
        <div class="status" id="timer-status">
            <div><strong>Timer State:</strong> <span id="timer-state">Loading...</span></div>
            <div><strong>Remaining Time:</strong> <span id="remaining-time">--:--</span></div>
            <div><strong>Is Active:</strong> <span id="is-active">--</span></div>
            <div><strong>Is Expired:</strong> <span id="is-expired">--</span></div>
        </div>
        
        <button onclick="checkTimerStatus()">Refresh Timer Status</button>
        <button onclick="clearTimer()">Clear Timer (Reset Test)</button>
    </div>

    <div class="test-section">
        <h3>‚úÖ Test Checklist</h3>
        <div id="test-results">
            <div class="status" id="test-1">1. Timer starts on /task/1: <span class="result">Not tested</span></div>
            <div class="status" id="test-2">2. Timer continues on /task/2: <span class="result">Not tested</span></div>
            <div class="status" id="test-3">3. Timer continues on /task/3: <span class="result">Not tested</span></div>
            <div class="status" id="test-4">4. Timer persists across navigation: <span class="result">Not tested</span></div>
            <div class="status" id="test-5">5. Timer resets from non-task page: <span class="result">Not tested</span></div>
        </div>
    </div>

    <div class="test-section">
        <h3>üîß Test Form Elements</h3>
        <p>These should be disabled when timer expires on ANY task page:</p>
        <input type="text" placeholder="Test input" id="test-input">
        <textarea placeholder="Test textarea" id="test-textarea"></textarea>
        <button type="button" id="test-button">Test Button</button>
    </div>

    <script>
        let testStartTime = null;
        let lastTimerValue = null;

        function navigateTo(path) {
            // Update URL display
            document.getElementById('url-display').textContent = path;
            
            // Simulate URL change
            Object.defineProperty(window.location, 'pathname', {
                writable: true,
                value: path
            });
            
            Object.defineProperty(window.location, 'href', {
                writable: true,
                value: window.location.origin + path
            });
            
            // Trigger extension URL change detection
            if (window.awsCountdownInitializer && 
                window.awsCountdownInitializer.getTimerController() && 
                window.awsCountdownInitializer.getTimerController().getUrlDetector()) {
                
                const urlDetector = window.awsCountdownInitializer.getTimerController().getUrlDetector();
                urlDetector.handleUrlChange();
            }
            
            // Check timer status after navigation
            setTimeout(() => {
                checkTimerStatus();
                runAutomaticTests(path);
            }, 100);
            
            console.log(`Navigated to: ${path}`);
        }

        function checkTimerStatus() {
            if (!window.awsCountdownInitializer || !window.awsCountdownInitializer.getTimerController()) {
                document.getElementById('timer-state').textContent = 'Extension not loaded';
                return;
            }
            
            const controller = window.awsCountdownInitializer.getTimerController();
            const timer = controller.getTimer();
            const state = timer.getState();
            
            document.getElementById('timer-state').textContent = 'Loaded';
            document.getElementById('remaining-time').textContent = formatTime(state.remainingTime);
            document.getElementById('is-active').textContent = state.isActive ? 'Yes' : 'No';
            document.getElementById('is-expired').textContent = state.isExpired ? 'Yes' : 'No';
            
            // Store for comparison
            lastTimerValue = state.remainingTime;
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.max(0, Math.ceil(milliseconds / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function clearTimer() {
            if (typeof localStorage !== 'undefined') {
                localStorage.removeItem('aws-countdown-timer-state');
                console.log('Timer state cleared');
                
                // Refresh the page to restart
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        function runAutomaticTests(currentPath) {
            // Test 1: Timer starts on /task/1
            if (currentPath === '/task/1') {
                const hasTimer = lastTimerValue !== null && lastTimerValue > 0;
                updateTestResult('test-1', hasTimer, 'Timer active on /task/1');
                
                if (!testStartTime) {
                    testStartTime = lastTimerValue;
                }
            }
            
            // Test 2 & 3: Timer continues on other task pages
            if (currentPath === '/task/2' || currentPath === '/task/3') {
                const hasTimer = lastTimerValue !== null && lastTimerValue > 0;
                const testId = currentPath === '/task/2' ? 'test-2' : 'test-3';
                updateTestResult(testId, hasTimer, `Timer continues on ${currentPath}`);
            }
            
            // Test 4: Timer persistence (value should be less than start time)
            if (testStartTime && lastTimerValue && currentPath.startsWith('/task/')) {
                const hasDecreased = lastTimerValue < testStartTime;
                updateTestResult('test-4', hasDecreased, 'Timer value decreases over time');
            }
            
            // Test 5: Timer reset from non-task page
            if (currentPath === '/home') {
                // This would be tested by going to /home then back to /task/1
                updateTestResult('test-5', true, 'Navigated to non-task page');
            }
        }

        function updateTestResult(testId, passed, message) {
            const element = document.getElementById(testId);
            const resultSpan = element.querySelector('.result');
            
            if (passed) {
                element.className = 'status success';
                resultSpan.textContent = '‚úÖ PASS - ' + message;
            } else {
                element.className = 'status error';
                resultSpan.textContent = '‚ùå FAIL - ' + message;
            }
        }

        // Initialize
        setTimeout(() => {
            navigateTo('/task/1');
        }, 1000);

        // Periodic status updates
        setInterval(checkTimerStatus, 2000);
    </script>
</body>
</html>